name: Heimdall Factory Build (Free Tier)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read
  packages: write   # Required for GitHub Container Registry
  id-token: write   # Required for Cosign signing

env:
  # use GitHub's built-in registry (Free for public repos)
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. Install Cosign (The Signing Tool)
      - name: Install Cosign
        uses: sigstore/cosign-installer@v3.7.0

      # 2. Install Syft (The SBOM Tool)
      - name: Install Syft
        uses: anchore/sbom-action/download-syft@v0.15.10

      # 3. Log in to GitHub Container Registry (NO AWS CREDENTIALS NEEDED)
      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 4. Build, Push, Sign, and Attest
      - name: Build, Push, Sign, and Attest
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # Docker requires lowercase names
          REPO_LOWER=$(echo "${{ env.IMAGE_NAME }}" | tr '[:upper:]' '[:lower:]')
          IMAGE_URI=$REGISTRY/$REPO_LOWER:$IMAGE_TAG
          
          # A. Build
          docker build -t $IMAGE_URI .
          
          # B. Push (To GitHub)
          docker push $IMAGE_URI
          
          # C. Sign (Keyless OIDC)
          cosign sign --yes $IMAGE_URI
          
          # D. Generate SBOM
          syft $IMAGE_URI -o spdx-json --file sbom.spdx.json
          
          # E. Attest SBOM
          cosign attest --yes --predicate sbom.spdx.json --type spdx $IMAGE_URI
          
          echo "::notice::Image Signed & Attested at: $IMAGE_URI"